<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Dashboard ‚Äî HAZA Collaborators</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Clash+Display:wght@400;500;600;700&family=Cabinet+Grotesk:wght@300;400;500;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#06060a;
  --surface:rgba(12,14,22,0.94);
  --surface2:rgba(14,16,26,0.88);
  --surface3:rgba(18,20,32,0.7);
  --border:rgba(255,180,60,0.1);
  --border-bright:rgba(255,180,60,0.25);
  --gold:#ffb43c;
  --gold2:#ff7c2a;
  --gold-dim:rgba(255,180,60,0.08);
  --cyan:#00e5ff;
  --green:#34d399;
  --red:#f87171;
  --amber:#fbbf24;
  --text:#f0ece4;
  --text-dim:#c8c2b8;
  --muted:#7a7568;
  --muted2:#504d46;
  --sidebar:248px;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{font-family:'Cabinet Grotesk',sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;}
#bg-canvas{position:fixed;inset:0;z-index:0;pointer-events:none;}
::-webkit-scrollbar{width:3px;height:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--muted2);border-radius:2px;}
::-webkit-scrollbar-thumb:hover{background:var(--gold);}

/* ‚îÄ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ‚îÄ */
#app{position:fixed;inset:0;z-index:10;display:flex;animation:fadeIn 0.4s both;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}

/* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
#sidebar{
  width:var(--sidebar);height:100vh;flex-shrink:0;
  background:rgba(6,6,10,0.98);-webkit-backdrop-filter:blur(24px);backdrop-filter:blur(24px);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;z-index:20;
}
.sb-brand{
  padding:20px 18px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:10px;
}
.sb-mark{
  width:36px;height:36px;border-radius:10px;flex-shrink:0;
  background:linear-gradient(135deg,var(--gold),var(--gold2));
  display:flex;align-items:center;justify-content:center;
  font-family:'Clash Display',sans-serif;font-weight:700;font-size:0.9rem;color:#000;
}
.sb-brand-name{font-family:'Clash Display',sans-serif;font-weight:700;font-size:0.95rem;color:var(--text);line-height:1.15;letter-spacing:-0.3px;}
.sb-brand-sub{font-size:0.68rem;color:var(--muted);font-family:'JetBrains Mono',monospace;}

.sb-nav{flex:1;overflow-y:auto;padding:12px 10px;}
.sb-section{padding:10px 8px 4px;font-size:0.63rem;color:var(--muted2);letter-spacing:2px;text-transform:uppercase;font-family:'JetBrains Mono',monospace;}
.sb-item{
  display:flex;align-items:center;gap:9px;
  padding:9px 10px;margin:1px 0;border-radius:9px;
  cursor:pointer;transition:all 0.15s;color:var(--muted);font-size:0.86rem;font-weight:500;
  border:1px solid transparent;text-decoration:none;
}
.sb-item:hover{background:var(--gold-dim);color:var(--text-dim);}
.sb-item.active{background:rgba(255,180,60,0.1);color:var(--gold);border-color:var(--border);}
.sb-item .si-icon{width:22px;text-align:center;font-size:0.95rem;flex-shrink:0;}

.sb-footer{padding:14px;border-top:1px solid var(--border);}
.sb-user{
  display:flex;align-items:center;gap:10px;
  padding:10px;border-radius:10px;
  background:var(--gold-dim);border:1px solid var(--border);
}
.sb-avatar{
  width:34px;height:34px;border-radius:9px;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  font-family:'Clash Display',sans-serif;font-weight:700;font-size:0.8rem;color:#000;
  background:linear-gradient(135deg,var(--gold),var(--gold2));
}
.sb-user-name{font-size:0.84rem;font-weight:700;line-height:1.2;}
.sb-user-role{display:flex;align-items:center;gap:5px;margin-top:3px;}
.dot-online{width:6px;height:6px;border-radius:50%;background:var(--green);flex-shrink:0;}
.role-badge{
  padding:1px 8px;border-radius:100px;font-size:0.62rem;
  font-family:'JetBrains Mono',monospace;font-weight:700;text-transform:uppercase;letter-spacing:0.3px;
}
.badge-admin{background:rgba(255,180,60,0.12);color:var(--gold);border:1px solid var(--border-bright);}
.badge-member{background:rgba(255,180,60,0.06);color:var(--muted);border:1px solid var(--border);}
.sb-logout{
  margin-left:auto;width:28px;height:28px;border-radius:7px;
  background:rgba(248,113,113,0.07);border:1px solid rgba(248,113,113,0.15);
  color:var(--red);cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:0.85rem;flex-shrink:0;transition:all 0.15s;
}
.sb-logout:hover{background:rgba(248,113,113,0.18);}

/* ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}

.topbar{
  height:54px;padding:0 24px;flex-shrink:0;
  display:flex;align-items:center;justify-content:space-between;
  background:rgba(6,6,10,0.82);-webkit-backdrop-filter:blur(20px);backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);
}
.tb-title{font-family:'Clash Display',sans-serif;font-size:1.05rem;font-weight:700;letter-spacing:-0.3px;}
.tb-right{display:flex;align-items:center;gap:10px;}
.tb-pill{
  display:flex;align-items:center;gap:6px;
  padding:5px 12px;border-radius:100px;
  background:rgba(52,211,153,0.06);border:1px solid rgba(52,211,153,0.18);
  font-size:0.72rem;color:var(--green);font-family:'JetBrains Mono',monospace;
}

/* ‚îÄ‚îÄ‚îÄ VIEWS ‚îÄ‚îÄ‚îÄ */
.view{display:none;flex:1;overflow:hidden;height:calc(100vh - 54px);}
.view.active{display:flex;flex-direction:column;}

/* ‚îÄ‚îÄ‚îÄ FEED ‚îÄ‚îÄ‚îÄ */
.feed-scroll{overflow-y:auto;padding:20px 24px;flex:1;}
.composer{
  padding:18px;border-radius:14px;margin-bottom:18px;
  background:var(--surface2);border:1px solid var(--border);
}
.compose-input{
  width:100%;padding:12px 14px;min-height:76px;resize:none;
  background:var(--gold-dim);border:1px solid var(--border);border-radius:9px;
  color:var(--text);font-family:'Cabinet Grotesk',sans-serif;font-size:0.9rem;outline:none;transition:all 0.2s;
}
.compose-input:focus{border-color:var(--gold);}
.compose-input::placeholder{color:var(--muted2);}
.composer-actions{display:flex;justify-content:flex-end;margin-top:10px;}

.post-card{
  padding:18px;border-radius:14px;margin-bottom:14px;
  background:var(--surface2);border:1px solid var(--border);transition:border-color 0.2s;
}
.post-card:hover{border-color:var(--border-bright);}
.post-header{display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.post-avatar{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-family:'Clash Display',sans-serif;font-weight:700;font-size:0.76rem;color:#000;flex-shrink:0;}
.post-author{font-weight:700;font-size:0.88rem;}
.post-time{font-size:0.72rem;color:var(--muted);font-family:'JetBrains Mono',monospace;}
.post-text{font-size:0.9rem;line-height:1.65;color:var(--text-dim);}
.post-footer{display:flex;align-items:center;gap:8px;margin-top:12px;}
.like-btn{
  display:flex;align-items:center;gap:5px;
  padding:5px 12px;border-radius:7px;border:1px solid var(--border);
  background:transparent;color:var(--muted);font-size:0.78rem;cursor:pointer;
  transition:all 0.15s;font-family:'Cabinet Grotesk',sans-serif;font-weight:600;
}
.like-btn:hover{border-color:var(--gold);color:var(--gold);}
.like-btn.liked{border-color:rgba(248,113,113,0.3);color:var(--red);background:rgba(248,113,113,0.06);}
.del-btn{
  margin-left:auto;padding:5px 10px;border-radius:7px;
  background:transparent;border:1px solid transparent;
  color:var(--muted2);font-size:0.75rem;cursor:pointer;transition:all 0.15s;
}
.del-btn:hover{border-color:rgba(248,113,113,0.2);color:var(--red);background:rgba(248,113,113,0.06);}

/* ‚îÄ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ‚îÄ */
#view-chat{flex-direction:column;}
.chat-msgs{flex:1;overflow-y:auto;padding:16px 24px;display:flex;flex-direction:column;gap:2px;}
.chat-bar{
  padding:14px 20px;border-top:1px solid var(--border);
  background:rgba(6,6,10,0.75);-webkit-backdrop-filter:blur(16px);backdrop-filter:blur(16px);flex-shrink:0;
}
.chat-bar-inner{display:flex;gap:10px;align-items:flex-end;}
.chat-input{
  flex:1;padding:11px 14px;border-radius:10px;
  background:var(--gold-dim);border:1px solid var(--border);
  color:var(--text);font-family:'Cabinet Grotesk',sans-serif;font-size:0.88rem;
  outline:none;resize:none;max-height:110px;transition:all 0.2s;
}
.chat-input:focus{border-color:var(--gold);}
.send-btn{
  width:42px;height:42px;border-radius:10px;border:none;flex-shrink:0;
  background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-size:1rem;transition:all 0.15s;box-shadow:0 2px 14px rgba(255,180,60,0.3);
}
.send-btn:hover{transform:scale(1.07);box-shadow:0 4px 20px rgba(255,180,60,0.45);}
.msg-wrap{display:flex;flex-direction:column;margin:3px 0;}
.msg-row{display:flex;align-items:flex-end;gap:7px;}
.msg-row.own{flex-direction:row-reverse;}
.msg-meta{font-size:0.67rem;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-bottom:3px;}
.msg-meta.own{text-align:right;}
.msg-bubble{
  max-width:62%;padding:9px 13px;border-radius:13px;
  font-size:0.87rem;line-height:1.55;word-break:break-word;
}
.msg-bubble.other{background:var(--surface2);border:1px solid var(--border);border-bottom-left-radius:3px;}
.msg-bubble.own{background:rgba(255,180,60,0.1);border:1px solid var(--border-bright);border-bottom-right-radius:3px;}
.msg-avatar{width:26px;height:26px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-family:'Clash Display',sans-serif;font-weight:700;font-size:0.65rem;color:#000;flex-shrink:0;}
.date-sep{text-align:center;margin:10px 0;}
.date-sep span{font-size:0.68rem;color:var(--muted2);font-family:'JetBrains Mono',monospace;background:rgba(6,6,10,0.85);padding:3px 12px;border-radius:100px;border:1px solid var(--border);}

/* ‚îÄ‚îÄ‚îÄ PROJECTS ‚îÄ‚îÄ‚îÄ */
#view-projects{overflow-y:auto;flex-wrap:wrap;align-content:flex-start;}
.proj-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;padding:20px 24px;width:100%;}
.proj-card{
  padding:22px;border-radius:14px;cursor:pointer;position:relative;overflow:hidden;
  background:var(--surface2);border:1px solid var(--border);transition:all 0.22s;
}
.proj-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--gold),var(--gold2));}
.proj-card:hover{border-color:var(--border-bright);transform:translateY(-2px);box-shadow:0 8px 32px rgba(0,0,0,0.4);}
.proj-name{font-family:'Clash Display',sans-serif;font-size:1rem;font-weight:700;margin-bottom:6px;letter-spacing:-0.3px;}
.proj-desc{font-size:0.83rem;color:var(--muted);line-height:1.5;}
.proj-meta{display:flex;align-items:center;gap:8px;margin-top:14px;font-size:0.72rem;color:var(--muted);font-family:'JetBrains Mono',monospace;}
.proj-add{
  display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;
  padding:22px;border-radius:14px;cursor:pointer;
  border:1.5px dashed var(--muted2);color:var(--muted);
  transition:all 0.2s;font-size:0.85rem;font-weight:600;
  background:transparent;min-height:120px;
}
.proj-add:hover{border-color:var(--gold);color:var(--gold);background:var(--gold-dim);}
.proj-del{
  position:absolute;top:12px;right:12px;
  background:rgba(248,113,113,0.08);border:1px solid rgba(248,113,113,0.15);
  color:var(--red);border-radius:6px;padding:4px 8px;cursor:pointer;
  font-size:0.72rem;opacity:0;transition:opacity 0.15s;
}
.proj-card:hover .proj-del{opacity:1;}

/* ‚îÄ‚îÄ‚îÄ PROJECT DETAIL ‚îÄ‚îÄ‚îÄ */
#proj-detail{
  display:none;position:fixed;inset:0;z-index:500;
  background:rgba(6,6,10,0.98);-webkit-backdrop-filter:blur(20px);backdrop-filter:blur(20px);
  animation:slideIn 0.28s cubic-bezier(0.16,1,0.3,1) both;
}
@keyframes slideIn{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
.pd-shell{display:flex;flex-direction:column;height:100%;}
.pd-topbar{
  height:54px;padding:0 20px;flex-shrink:0;
  display:flex;align-items:center;gap:14px;
  border-bottom:1px solid var(--border);
  background:rgba(6,6,10,0.95);
}
.back-btn{
  display:flex;align-items:center;gap:6px;
  padding:6px 14px;border-radius:8px;border:1px solid var(--border);
  background:transparent;color:var(--muted);cursor:pointer;
  font-family:'Cabinet Grotesk',sans-serif;font-size:0.83rem;font-weight:600;
  transition:all 0.15s;
}
.back-btn:hover{border-color:var(--gold);color:var(--gold);}
.pd-name{font-family:'Clash Display',sans-serif;font-size:1rem;font-weight:700;letter-spacing:-0.3px;}
.pd-desc-tag{font-size:0.78rem;color:var(--muted);}
.pd-tabs{
  display:flex;gap:0;padding:0 20px;border-bottom:1px solid var(--border);flex-shrink:0;
  background:rgba(6,6,10,0.85);
}
.pd-tab{
  padding:12px 18px;border:none;background:transparent;
  color:var(--muted);font-family:'Cabinet Grotesk',sans-serif;font-size:0.87rem;font-weight:600;
  cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all 0.15s;
}
.pd-tab.active{color:var(--gold);border-bottom-color:var(--gold);}
.pd-body{flex:1;overflow:hidden;display:flex;flex-direction:column;}
.pd-pane{display:none;flex:1;overflow:hidden;flex-direction:column;}
.pd-pane.active{display:flex;}

/* ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ */
.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:7px;
  padding:9px 18px;border-radius:9px;font-family:'Cabinet Grotesk',sans-serif;
  font-weight:700;font-size:0.85rem;cursor:pointer;border:none;
  transition:all 0.17s;white-space:nowrap;text-decoration:none;
}
.btn-gold{
  background:linear-gradient(135deg,var(--gold),var(--gold2));color:#000;
  box-shadow:0 3px 14px rgba(255,180,60,0.25);
}
.btn-gold:hover{box-shadow:0 5px 24px rgba(255,180,60,0.4);transform:translateY(-1px);}
.btn-ghost{background:rgba(255,255,255,0.04);color:var(--text-dim);border:1px solid var(--border);}
.btn-ghost:hover{background:rgba(255,180,60,0.06);border-color:var(--border-bright);color:var(--text);}
.btn-sm{padding:6px 13px;font-size:0.78rem;}

/* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
.modal-backdrop{
  position:fixed;inset:0;z-index:800;background:rgba(0,0,0,0.65);
  -webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px);
  display:flex;align-items:center;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity 0.2s;
}
.modal-backdrop.open{opacity:1;pointer-events:all;}
.modal-box{
  width:460px;max-width:94vw;padding:30px;border-radius:20px;
  background:rgba(8,9,16,0.99);border:1px solid var(--border-bright);
  box-shadow:0 20px 60px rgba(0,0,0,0.7);
  animation:modalIn 0.25s cubic-bezier(0.16,1,0.3,1) both;
}
@keyframes modalIn{from{opacity:0;transform:scale(0.95) translateY(10px);}to{opacity:1;transform:scale(1) translateY(0);}}
.modal-title{font-family:'Clash Display',sans-serif;font-size:1.1rem;font-weight:700;margin-bottom:22px;letter-spacing:-0.3px;}
.fg{margin-bottom:15px;}
.field-label{display:block;margin-bottom:6px;font-size:0.72rem;font-weight:700;color:var(--muted);letter-spacing:0.8px;text-transform:uppercase;font-family:'JetBrains Mono',monospace;}
.field{
  width:100%;padding:11px 14px;background:var(--gold-dim);
  border:1px solid var(--border);border-radius:9px;
  color:var(--text);font-family:'Cabinet Grotesk',sans-serif;font-size:0.9rem;outline:none;transition:all 0.2s;
}
.field:focus{border-color:var(--gold);}
.field::placeholder{color:var(--muted2);}
.modal-footer{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;}

/* TOAST */
#toast{
  position:fixed;bottom:24px;right:24px;z-index:9999;
  padding:12px 18px;border-radius:12px;font-size:0.85rem;font-weight:600;
  transform:translateY(70px);opacity:0;transition:all 0.3s cubic-bezier(0.16,1,0.3,1);
  pointer-events:none;display:flex;align-items:center;gap:9px;
}
#toast.show{transform:translateY(0);opacity:1;}
#toast.success{background:rgba(52,211,153,0.1);border:1px solid rgba(52,211,153,0.3);color:var(--green);}
#toast.error{background:rgba(248,113,113,0.1);border:1px solid rgba(248,113,113,0.3);color:var(--red);}
#toast.info{background:var(--gold-dim);border:1px solid var(--border-bright);color:var(--gold);}

/* EMPTY + LOADING */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;padding:50px 20px;color:var(--muted);text-align:center;}
.empty .ei{font-size:2.2rem;opacity:0.45;}
.empty p{font-size:0.85rem;line-height:1.55;}
.loading{display:flex;align-items:center;justify-content:center;height:100%;gap:10px;color:var(--muted);font-size:0.85rem;}
.loader{width:20px;height:20px;border:2px solid var(--border-bright);border-top-color:var(--gold);border-radius:50%;animation:spin 0.7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* pupdates padding wrapper */
.pupdates-wrap{padding:18px 20px;overflow-y:auto;flex:1;}
.proj-upd-scroll{overflow-y:auto;flex:1;}

/* MARKDOWN STYLES */
.markdown-body { font-size: 0.88rem; line-height: 1.6; color: var(--text-dim); }
.markdown-body p { margin-bottom: 8px; }
.markdown-body p:last-child { margin-bottom: 0; }
.markdown-body strong { color: var(--gold); font-weight: 700; }
.markdown-body em { color: var(--gold2); font-style: italic; }
.markdown-body ul, .markdown-body ol { margin-bottom: 8px; padding-left: 20px; }
.markdown-body li { margin-bottom: 4px; }
.markdown-body code { font-family: 'JetBrains Mono', monospace; background: rgba(0,0,0,0.3); padding: 2px 5px; border-radius: 4px; font-size: 0.8em; color: var(--cyan); }
.markdown-body pre { background: rgba(0,0,0,0.4); padding: 10px; border-radius: 8px; overflow-x: auto; margin-bottom: 8px; }
.markdown-body pre code { background: transparent; padding: 0; color: inherit; }

/* NOTES STYLES */
.note-item { padding: 16px; border-radius: 12px; background: var(--surface2); border: 1px solid var(--border); margin-bottom: 12px; position: relative; }
.note-item:hover { border-color: var(--border-bright); }
.note-text { font-size: 0.9rem; line-height: 1.6; color: var(--text-dim); word-break: break-word; }
.note-meta { font-size: 0.7rem; color: var(--muted); font-family: 'JetBrains Mono', monospace; margin-top: 10px; }
.note-del { position: absolute; top: 12px; right: 12px; background: rgba(248,113,113,0.08); border: 1px solid rgba(248,113,113,0.15); color: var(--red); border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.72rem; opacity: 0; transition: opacity 0.15s; }
.note-item:hover .note-del { opacity: 1; }

/* UTILITIES FOR LINT WARNINGS */
.d-none { display: none !important; }
.flex-1-min-0 { flex: 1; min-width: 0; }
.pd-tabs-flex { display: flex; gap: 15px; margin: 24px 0 16px; }
.pd-tab-btn { background: none; border: none; border-bottom: 2px solid transparent; color: var(--muted); font-size: 1rem; font-weight: 600; font-family: 'Clash Display', sans-serif; cursor: pointer; padding-bottom: 6px; transition: all 0.2s; }
.mb-20 { margin-bottom: 20px; }
.chat-bar-inner-rd { border-radius: 12px; }
.chat-input-pad { font-size: 0.9rem; padding: 12px 16px; }
.pad-100w { padding: 20px; width: 100%; }
.empty-proj-wrap { display: flex; flex-direction: column; align-items: center; margin-bottom: 30px; }
.desc-field { min-height: 72px; resize: none; }
.welcome-box { max-width: 520px; padding: 30px; }
.font-1-3 { font-size: 1.3rem; }
.welcome-body { max-height: 50vh; overflow-y: auto; padding: 10px 0; margin-bottom: 20px; }
.w-100 { width: 100%; }
.avatar-flex { display: flex; gap: 10px; align-items: center; }
.avatar-prev { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #000; font-family: 'Clash Display', sans-serif; font-weight: 700; font-size: 1rem; }
.flex-1 { flex: 1; }
.mt-24 { margin-top: 24px; }
</style>
</head>
<body>
<canvas id="bg-canvas"></canvas>
<div id="toast"></div>

<div id="app">
  <!-- SIDEBAR -->
  <div id="sidebar">
    <div class="sb-brand">
      <div class="sb-mark">H</div>
      <div>
        <div class="sb-brand-name">HAZA Collaborators</div>
        <div class="sb-brand-sub">Team Workspace</div>
      </div>
    </div>
    <div class="sb-nav">
      <div class="sb-section">General</div>
      <div class="sb-item active" onclick="showView('feed')">
        <span class="si-icon">üìã</span> Feed
      </div>
      <div class="sb-item" onclick="showView('chat')">
        <span class="si-icon">üí¨</span> Team Chat
      </div>
      <div class="sb-section">Work</div>
      <div class="sb-item" onclick="showView('projects')">
        <span class="si-icon">üóÇÔ∏è</span> Projects
      </div>
      <div class="sb-item" onclick="showView('bot')">
        <span class="si-icon">ü§ñ</span> AI Bot
      </div>
      <div class="sb-item" onclick="showView('notes')">
        <span class="si-icon">üìù</span> My Notes
      </div>
      <div class="sb-item" onclick="openProfile()">
        <span class="si-icon">üë§</span> My Profile
      </div>
      <div class="sb-item admin-only d-none" onclick="goAdmin()">
        <span class="si-icon">‚öôÔ∏è</span> Admin Panel
      </div>
    </div>
    <div class="sb-footer">
      <div class="sb-user">
        <div class="sb-avatar" id="sb-avatar">H</div>
        <div class="flex-1-min-0">
          <div class="sb-user-name" id="sb-name">‚Äî</div>
          <div class="sb-user-role">
            <span class="dot-online"></span>
            <span class="role-badge" id="sb-badge">member</span>
          </div>
        </div>
        <button class="sb-logout" onclick="doLogout()" title="Logout">‚èª</button>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div id="main">
    <div class="topbar">
      <div class="tb-title" id="tb-title">Feed</div>
      <div class="tb-right">
        <div class="tb-pill">
          <span class="dot-online"></span>
          <span id="member-count">Loading...</span>
        </div>
      </div>
    </div>

    <!-- FEED VIEW -->
    <div class="view active" id="view-feed">
      <div class="feed-scroll">
        <div class="composer">
          <textarea class="compose-input" id="post-input" placeholder="Share an update with your team..."></textarea>
          <div class="composer-actions">
            <button class="btn btn-gold btn-sm" onclick="submitPost()">Post Update</button>
          </div>
        </div>
        <div id="feed-list"><div class="loading"><div class="loader"></div> Loading posts...</div></div>
      </div>
    </div>

    <!-- CHAT VIEW -->
    <div class="view" id="view-chat">
      <div class="chat-msgs" id="chat-msgs"><div class="loading"><div class="loader"></div> Loading messages...</div></div>
      <div class="chat-bar">
        <div class="chat-bar-inner">
          <textarea class="chat-input" id="chat-input" rows="1" placeholder="Message your team..."
            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMsg();}"></textarea>
          <button class="send-btn" onclick="sendMsg()">‚û§</button>
        </div>
      </div>
    </div>

    <!-- PROJECTS VIEW -->
    <div class="view" id="view-projects">
      <div class="proj-grid" id="proj-grid"><div class="loading"><div class="loader"></div> Loading projects...</div></div>
    </div>

    <!-- BOT VIEW -->
    <div class="view" id="view-bot" style="display:none;flex:1;flex-direction:column;overflow:hidden;height:calc(100vh - 54px);">
      <div style="margin:20px 24px 0;background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.2);padding:12px 14px;border-radius:10px;font-size:0.8rem;color:var(--amber);line-height:1.5;">
        ‚ö†Ô∏è Warning: Please communicate in English as Sinhala is not fully supported yet.
      </div>
      <div class="chat-msgs" id="bot-msgs" style="flex:1;overflow-y:auto;padding:16px 24px;display:flex;flex-direction:column;gap:5px;">
        <div class="empty" id="bot-empty"><div class="ei">ü§ñ</div><p>Hi! I'm HAZA AI. How can I help you today?</p></div>
      </div>
      <div class="chat-bar">
        <div class="chat-bar-inner">
          <textarea class="chat-input" id="bot-input" rows="1" placeholder="Message HAZA AI..."
            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendBotMsg();}"></textarea>
          <button class="send-btn" onclick="sendBotMsg()">‚û§</button>
        </div>
      </div>
    </div>
    
    <!-- NOTES VIEW -->
    <div class="view" id="view-notes" style="display:none;flex:1;flex-direction:column;overflow:hidden;height:calc(100vh - 54px);">
      <div style="margin:20px 24px 0;background:rgba(255,180,60,0.06);border:1px solid rgba(255,180,60,0.2);padding:12px 14px;border-radius:10px;font-size:0.8rem;color:var(--gold);line-height:1.5;">
        ‚ö†Ô∏è <strong>Privacy Warning:</strong> Please be aware that these notes are saved <strong>ONLY locally</strong> on your browser's (client-side) Local Storage. They are <strong>NOT saved</strong> to the cloud database. If you clear your browser data or use another device, you won't see them!
      </div>
      <div class="feed-scroll" style="display:flex;flex-direction:column;">
        <div class="composer">
          <textarea class="compose-input" id="note-input" placeholder="Write a new personal note..."></textarea>
          <div class="composer-actions">
            <button class="btn btn-gold btn-sm" onclick="saveNote()">Save Note</button>
          </div>
        </div>
        <div id="notes-list" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- PROJECT DETAIL -->
<div id="proj-detail">
  <div class="pd-shell">
    <div class="pd-topbar">
      <button class="back-btn" onclick="closeProj()">‚Üê Back</button>
      <div>
        <div class="pd-name" id="pd-name">‚Äî</div>
        <div class="pd-desc-tag" id="pd-desc">‚Äî</div>
      </div>
    </div>
    <div class="pd-tabs">
      <button class="pd-tab active" onclick="switchPTab('updates')">üìã Updates</button>
      <button class="pd-tab" onclick="switchPTab('pchat')">üí¨ Chat</button>
    </div>
    <div class="pd-body">
      <div class="pd-pane active" id="ptab-updates">
        <div class="pupdates-wrap">
          <div class="composer" style="margin-bottom:16px;">
            <textarea class="compose-input" id="pu-input" placeholder="Post a project update..."></textarea>
            <div class="composer-actions">
              <button class="btn btn-gold btn-sm" onclick="submitPUpdate()">Post Update</button>
            </div>
          </div>
          <div id="pupdates-list"></div>
        </div>
      </div>
      <div class="pd-pane" id="ptab-pchat">
        <div class="chat-msgs" id="pchat-msgs"></div>
        <div class="chat-bar">
          <div class="chat-bar-inner">
            <textarea class="chat-input" id="pchat-input" rows="1" placeholder="Message the project team..."
              onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendPMsg();}"></textarea>
            <button class="send-btn" onclick="sendPMsg()">‚û§</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- NEW PROJECT MODAL -->
<div class="modal-backdrop" id="modal-newproj">
  <div class="modal-box">
    <div class="modal-title">üóÇÔ∏è Create New Project</div>
    <div class="fg">
      <label class="field-label">Project Name</label>
      <input id="np-name" class="field" placeholder="e.g. HAZA Website v2"/>
    </div>
    <div class="fg">
      <label class="field-label">Description</label>
      <textarea id="np-desc" class="field" style="min-height:72px;resize:none;" placeholder="Brief description..."></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-newproj')">Cancel</button>
      <button class="btn btn-gold" onclick="createProject()">Create Project</button>
    </div>
  </div>
</div>

<!-- WELCOME MODAL -->
<div class="modal-backdrop" id="modal-welcome">
  <div class="modal-box welcome-box">
    <div class="modal-title font-1-3">üëã Welcome</div>
    <div class="markdown-body welcome-body" id="welcome-note-content"></div>
    <button class="btn btn-gold w-100" onclick="closeModal('modal-welcome')">Get Started</button>
  </div>
</div>

<!-- PROFILE SETTINGS MODAL -->
<div class="modal-backdrop" id="modal-profile">
  <div class="modal-box">
    <div class="modal-title">‚öôÔ∏è Profile Settings</div>
    
    <div class="fg">
      <label class="field-label">Avatar Color</label>
      <div class="avatar-flex">
        <div id="prof-avatar-prev" class="avatar-prev">?</div>
        <select id="prof-color" class="field flex-1" title="Avatar Color" onchange="document.getElementById('prof-avatar-prev').style.background='linear-gradient(135deg,'+this.value+',#00b4d8)'">
          <option value="#ffb43c">Gold</option>
          <option value="#ff7c2a">Orange</option>
          <option value="#00e5ff">Cyan</option>
          <option value="#34d399">Green</option>
          <option value="#f87171">Red</option>
          <option value="#a78bfa">Purple</option>
          <option value="#60a5fa">Blue</option>
        </select>
      </div>
    </div>
    
    <div class="fg">
      <label class="field-label">Display Name</label>
      <input id="prof-name" class="field" placeholder="Your name..."/>
    </div>
    
    <div class="fg">
      <label class="field-label">New Password (Optional)</label>
      <input id="prof-pw" class="field" type="password" placeholder="Leave blank to keep current password"/>
    </div>
    
    <div class="modal-footer mt-24">
      <button class="btn btn-ghost" onclick="closeModal('modal-profile')">Cancel</button>
      <button class="btn btn-gold" id="btn-save-profile" onclick="saveProfile()">Save Profile</button>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
import {
  getFirestore, collection, doc, getDoc, getDocs, addDoc, deleteDoc,
  onSnapshot, query, orderBy, serverTimestamp, updateDoc, arrayUnion, arrayRemove
} from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
import { getDatabase, ref, push, onValue, serverTimestamp as rtServerTimestamp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCXqiGYfRyAEBjz9I_ZHaMnkGXTvuATgps",
  authDomain: "haza-collaborators.firebaseapp.com",
  databaseURL: "https://haza-collaborators-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "haza-collaborators",
  storageBucket: "haza-collaborators.firebasestorage.app",
  messagingSenderId: "1053559570462",
  appId: "1:1053559570462:web:5459a512e9218b136eae0f",
  measurementId: "G-CS32VS7LH5"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
const rtdb = getDatabase(app);

let CU = null;
let feedUnsub = null;

// ‚îÄ‚îÄ‚îÄ AUTH CHECK ‚îÄ‚îÄ‚îÄ
onAuthStateChanged(auth, async (user) => {
  if (!user) { window.location.href = 'login.html'; return; }
  const uSnap = await getDoc(doc(db,'users',user.uid));
  if (uSnap.exists()) {
    CU = { uid: user.uid, ...uSnap.data() };
  } else {
    // Auto-create profile
    const { setDoc } = await import("https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js");
    const profile = { uid:user.uid, name:user.displayName||user.email.split('@')[0], email:user.email, role:'member', color:'#ffb43c', joined:serverTimestamp() };
    await setDoc(doc(db,'users',user.uid), profile);
    CU = { uid:user.uid, ...profile };
  }
  initUI();
  checkWelcomeNote();
});

// ‚îÄ‚îÄ‚îÄ WELCOME NOTE & PROFILE ‚îÄ‚îÄ‚îÄ
window.checkWelcomeNote = async function() {
  try {
    const s = await getDoc(doc(db,'settings','welcome_note'));
    if(s.exists() && s.data().content) {
      document.getElementById('welcome-note-content').innerHTML = marked.parse(s.data().content);
      openModal('modal-welcome');
    }
  } catch(e){}
};

window.openProfile = function() {
  document.getElementById('prof-name').value = CU.name || '';
  if(CU.color) {
    document.getElementById('prof-color').value = CU.color;
    document.getElementById('prof-avatar-prev').style.background = `linear-gradient(135deg,${CU.color},#00b4d8)`;
  } else {
    document.getElementById('prof-avatar-prev').style.background = `linear-gradient(135deg,#ffb43c,#00b4d8)`;
  }
  document.getElementById('prof-avatar-prev').textContent = initials(CU.name || CU.email);
  document.getElementById('prof-pw').value = '';
  openModal('modal-profile');
};

window.saveProfile = async function() {
  const btn = document.getElementById('btn-save-profile');
  const n = document.getElementById('prof-name').value.trim();
  const c = document.getElementById('prof-color').value;
  const pw = document.getElementById('prof-pw').value;
  
  btn.disabled = true; btn.textContent = 'Saving...';
  try {
    let toUpdate = { name: n, color: c };
    
    // Attempt to update password if provided
    if (pw) {
      if (pw.length < 6) throw new Error("Password must be at least 6 characters.");
      await updatePassword(auth.currentUser, pw);
      toUpdate.password = pw; // Sync for admin panel references
    }
    
    await updateDoc(doc(db,'users',CU.uid), toUpdate);
    CU.name = n; CU.color = c;
    
    // Update live UI
    document.getElementById('sb-avatar').textContent = initials(n);
    document.getElementById('sb-avatar').style.background = `linear-gradient(135deg,${c},${c})`;
    document.getElementById('sb-name').textContent = n;
    
    toast('Profile updated successfully!', 'success');
    closeModal('modal-profile');
  } catch(e) {
    console.error(e);
    // User might need to re-authenticate if it's a sensitive operation failing
    if (e.code === 'auth/requires-recent-login') {
      toast('Please log out and log back in to change your password.', 'error');
    } else {
      toast('Error: ' + e.message, 'error');
    }
  }
  btn.disabled = false; btn.textContent = 'Save Profile';
};

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function timeAgo(ts){
  if(!ts)return '';
  const d=Date.now()-(ts.toMillis?ts.toMillis():ts);
  const m=60e3,h=3600e3,day=86400e3;
  if(d<30e3)return'Just now';if(d<m)return Math.floor(d/1e3)+'s ago';
  if(d<h)return Math.floor(d/m)+'m ago';if(d<day)return Math.floor(d/h)+'h ago';
  return Math.floor(d/day)+'d ago';
}
function fmtTime(ts){
  if(!ts)return '';
  const d=ts.toMillis?new Date(ts.toMillis()):new Date(ts);
  return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
}
function initials(n){return String(n||'?').split(' ').map(c=>c[0]).join('').slice(0,2).toUpperCase();}
function toast(msg,type='info'){
  const el=document.getElementById('toast');
  el.textContent=msg;el.className=`show ${type}`;
  clearTimeout(el._t);el._t=setTimeout(()=>el.className='',3000);
}
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
document.addEventListener('click',e=>{if(e.target.classList.contains('modal-backdrop'))e.target.classList.remove('open');});
window.openModal = openModal;
window.closeModal = closeModal;

// ‚îÄ‚îÄ‚îÄ INIT UI ‚îÄ‚îÄ‚îÄ
function initUI(){
  const av = document.getElementById('sb-avatar');
  av.textContent = initials(CU.name||CU.email);
  document.getElementById('sb-name').textContent = CU.name||CU.email;
  const rb = document.getElementById('sb-badge');
  rb.textContent = CU.role||'member';
  rb.className = 'role-badge '+(CU.role==='admin'?'badge-admin':'badge-member');
  document.querySelectorAll('.admin-only').forEach(el=>{
    if(CU.role==='admin') el.classList.remove('d-none');
    el.style.display=CU.role==='admin'?'flex':'none';
  });
  getDocs(collection(db,'users')).then(s=>{ document.getElementById('member-count').textContent=s.size+' members'; });
  showView('feed');
}

// ‚îÄ‚îÄ‚îÄ VIEW NAV ‚îÄ‚îÄ‚îÄ
const viewTitles={feed:'Feed',chat:'Team Chat',projects:'Projects',bot:'HAZA AI Bot',notes:'My Notes (Local)'};
window.showView = function(name){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  const targetView = document.getElementById('view-'+name);
  if(targetView) {
    if(targetView.style.display==='none' && (name==='bot'||name==='notes')) targetView.style.display='flex';
    targetView.classList.add('active');
  }
  if(name!=='bot' && document.getElementById('view-bot')) document.getElementById('view-bot').style.display='none';
  if(name!=='notes' && document.getElementById('view-notes')) document.getElementById('view-notes').style.display='none';
  document.querySelectorAll('.sb-item').forEach(i=>i.classList.remove('active'));
  document.querySelector(`.sb-item[onclick*="'${name}'"]`)?.classList.add('active');
  document.getElementById('tb-title').textContent=viewTitles[name]||name;
  if(name==='feed')listenFeed();
  if(name==='chat')listenChat();
  if(name==='projects')renderProjects();
  if(name==='notes')renderNotes();
};

// ‚îÄ‚îÄ‚îÄ FEED ‚îÄ‚îÄ‚îÄ
let feedUsers = {};
async function loadUsers(){ const s=await getDocs(collection(db,'users'));s.forEach(d=>{feedUsers[d.id]=d.data();}); }

window.submitPost = async function(){
  const t=document.getElementById('post-input').value.trim();if(!t)return;
  await addDoc(collection(db,'posts'),{uid:CU.uid,name:CU.name||CU.email,color:CU.color||'#ffb43c',text:t,ts:serverTimestamp(),likes:[]});
  document.getElementById('post-input').value='';
  toast('Posted!','success');
};

function listenFeed(){
  if(feedUnsub)feedUnsub();
  loadUsers().then(()=>{
    const q=query(collection(db,'posts'),orderBy('ts','desc'));
    feedUnsub=onSnapshot(q,snap=>{
      const posts=[];snap.forEach(d=>posts.push({id:d.id,...d.data()}));renderFeed(posts);
    });
  });
}

function renderFeed(posts){
  const c=document.getElementById('feed-list');
  if(!posts.length){c.innerHTML='<div class="empty"><div class="ei">üì≠</div><p>No posts yet. Be the first!</p></div>';return;}
  c.innerHTML=posts.map(p=>{
    const u=feedUsers[p.uid]||{name:p.name||'Unknown',color:p.color||'#ffb43c'};
    const liked=(p.likes||[]).includes(CU.uid);
    const canDel=CU.role==='admin'||p.uid===CU.uid;
    const likesJson=JSON.stringify(p.likes||[]).replace(/"/g,'&quot;');
    return `<div class="post-card">
      <div class="post-header">
        <div class="post-avatar" style="background:linear-gradient(135deg,${u.color||'#ffb43c'},${u.color||'#ff7c2a'});">${initials(u.name||p.name||'?')}</div>
        <div><div class="post-author">${esc(u.name||p.name||'Unknown')}</div><div class="post-time">${timeAgo(p.ts)}</div></div>
      </div>
      <div class="post-text">${esc(p.text).replace(/\n/g,'<br>')}</div>
      <div class="post-footer">
        <button class="like-btn${liked?' liked':''}" onclick="toggleLike('${p.id}','${likesJson}')">
          ${liked?'‚ù§Ô∏è':'ü§ç'} ${(p.likes||[]).length}
        </button>
        ${canDel?`<button class="del-btn" onclick="delPost('${p.id}')">Delete</button>`:''}
      </div>
    </div>`;
  }).join('');
}

window.toggleLike = async function(id, likesJson){
  const likes=JSON.parse(likesJson.replace(/&quot;/g,'"'));
  const r=doc(db,'posts',id);
  if(likes.includes(CU.uid)) await updateDoc(r,{likes:arrayRemove(CU.uid)});
  else await updateDoc(r,{likes:arrayUnion(CU.uid)});
};
window.delPost = async function(id){ await deleteDoc(doc(db,'posts',id)); };

// ‚îÄ‚îÄ‚îÄ CHAT (Realtime DB) ‚îÄ‚îÄ‚îÄ
window.sendMsg = function(){
  const inp=document.getElementById('chat-input');
  const t=inp.value.trim();if(!t)return;
  push(ref(rtdb,'messages'),{uid:CU.uid,name:CU.name||CU.email,color:CU.color||'#ffb43c',text:t,ts:rtServerTimestamp()});
  inp.value='';
};

function listenChat(){
  onValue(ref(rtdb,'messages'),snap=>{
    const msgs=[];snap.forEach(c=>msgs.push({id:c.key,...c.val()}));
    renderMsgs(msgs,'chat-msgs');
  });
}

function renderMsgs(msgs,cid){
  const c=document.getElementById(cid);
  if(!msgs.length){c.innerHTML='<div class="empty"><div class="ei">üí¨</div><p>No messages yet. Say hi!</p></div>';return;}
  let html='',lastDate='';
  msgs.forEach(m=>{
    const own=m.uid===CU.uid;
    const d=m.ts?new Date(m.ts).toLocaleDateString():'Today';
    if(d!==lastDate){html+=`<div class="date-sep"><span>${d}</span></div>`;lastDate=d;}
    html+=`<div class="msg-wrap">
      <div class="msg-meta${own?' own':''}">${own?'You':esc(m.name||'Unknown')} &nbsp;¬∑&nbsp; ${m.ts?fmtTime(m.ts):''}</div>
      <div class="msg-row${own?' own':''}">
        ${!own?`<div class="msg-avatar" style="background:linear-gradient(135deg,${m.color||'#ffb43c'},${m.color||'#ff7c2a'});">${initials(m.name||'?')}</div>`:''}
        <div class="msg-bubble ${own?'own':'other'}">${esc(m.text).replace(/\n/g,'<br>')}</div>
      </div>
    </div>`;
  });
  c.innerHTML=html;c.scrollTop=c.scrollHeight;
}

// ‚îÄ‚îÄ‚îÄ PROJECTS (Firestore) ‚îÄ‚îÄ‚îÄ
window.renderProjects = async function(){
  const g=document.getElementById('proj-grid');
  g.innerHTML='<div class="loading"><div class="loader"></div> Loading...</div>';
  const snap=await getDocs(query(collection(db,'projects'),orderBy('ts','desc')));
  const projs=[];snap.forEach(d=>projs.push({id:d.id,...d.data()}));
  let html=projs.map(p=>`
    <div class="proj-card" onclick="openProj('${p.id}')">
      ${CU.role==='admin'?`<button class="proj-del" onclick="event.stopPropagation();delProj('${p.id}')">‚úï Remove</button>`:''}
      <div class="proj-name">${esc(p.name)}</div>
      <div class="proj-desc">${esc(p.desc||'No description provided.')}</div>
      <div class="proj-meta">üë§ ${esc(p.creatorName||'Unknown')} &nbsp;¬∑&nbsp; ${timeAgo(p.ts)}</div>
    </div>`).join('');
  if(CU.role==='admin') html+=`<button class="proj-add" onclick="openModal('modal-newproj')"><span style="font-size:1.6rem;opacity:0.4;">+</span>New Project</button>`;
  if(!projs.length&&CU.role!=='admin') html='<div style="padding:20px;width:100%;"><div class="empty"><div class="ei">üóÇÔ∏è</div><p>No projects yet.</p></div></div>';
  g.innerHTML=html;
};

window.createProject = async function(){
  const name=document.getElementById('np-name').value.trim();
  const desc=document.getElementById('np-desc').value.trim();
  if(!name){toast('Project name required','error');return;}
  await addDoc(collection(db,'projects'),{name,desc,creatorUid:CU.uid,creatorName:CU.name||CU.email,ts:serverTimestamp()});
  closeModal('modal-newproj');
  document.getElementById('np-name').value='';document.getElementById('np-desc').value='';
  renderProjects();toast('Project created!','success');
};
window.delProj = async function(id){ await deleteDoc(doc(db,'projects',id));renderProjects(); };

// ‚îÄ‚îÄ‚îÄ PROJECT DETAIL ‚îÄ‚îÄ‚îÄ
let curProjId=null;
window.openProj = async function(id){
  const pSnap=await getDoc(doc(db,'projects',id));if(!pSnap.exists())return;
  const p={id:pSnap.id,...pSnap.data()};curProjId=id;
  document.getElementById('pd-name').textContent=p.name;
  document.getElementById('pd-desc').textContent=p.desc||'No description';
  document.getElementById('proj-detail').style.display='block';
  switchPTab('updates');
};
window.closeProj = function(){ document.getElementById('proj-detail').style.display='none';curProjId=null; };
window.switchPTab = function(name){
  document.querySelectorAll('.pd-tab').forEach((b,i)=>b.classList.toggle('active',['updates','pchat'][i]===name));
  document.getElementById('ptab-updates').classList.toggle('active',name==='updates');
  document.getElementById('ptab-pchat').classList.toggle('active',name==='pchat');
  if(name==='updates')loadPUpdates();
  if(name==='pchat')listenPChat();
};

window.submitPUpdate = async function(){
  if(!curProjId)return;
  const t=document.getElementById('pu-input').value.trim();if(!t)return;
  await addDoc(collection(db,'projects',curProjId,'updates'),{uid:CU.uid,name:CU.name||CU.email,color:CU.color||'#ffb43c',text:t,ts:serverTimestamp()});
  document.getElementById('pu-input').value='';toast('Update posted!','success');loadPUpdates();
};

async function loadPUpdates(){
  if(!curProjId)return;
  const snap=await getDocs(query(collection(db,'projects',curProjId,'updates'),orderBy('ts','desc')));
  const posts=[];snap.forEach(d=>posts.push({id:d.id,...d.data()}));
  const c=document.getElementById('pupdates-list');
  if(!posts.length){c.innerHTML='<div class="empty"><div class="ei">üìã</div><p>No updates yet.</p></div>';return;}
  c.innerHTML=posts.map(p=>`
    <div class="post-card" style="margin-bottom:12px;">
      <div class="post-header">
        <div class="post-avatar" style="background:linear-gradient(135deg,${p.color||'#ffb43c'},${p.color||'#ff7c2a'});">${initials(p.name||'?')}</div>
        <div><div class="post-author">${esc(p.name||'Unknown')}</div><div class="post-time">${timeAgo(p.ts)}</div></div>
      </div>
      <div class="post-text">${esc(p.text).replace(/\n/g,'<br>')}</div>
    </div>`).join('');
}

window.sendPMsg = function(){
  if(!curProjId)return;
  const inp=document.getElementById('pchat-input');
  const t=inp.value.trim();if(!t)return;
  push(ref(rtdb,`proj_messages/${curProjId}`),{uid:CU.uid,name:CU.name||CU.email,color:CU.color||'#ffb43c',text:t,ts:rtServerTimestamp()});
  inp.value='';
};

function listenPChat(){
  onValue(ref(rtdb,`proj_messages/${curProjId}`),snap=>{
    const msgs=[];snap.forEach(c=>msgs.push({id:c.key,...c.val()}));
    renderMsgs(msgs,'pchat-msgs');
  });
}

// ‚îÄ‚îÄ‚îÄ AI BOT (Pollinations API) ‚îÄ‚îÄ‚îÄ
let botHistory = [];
async function getSystemPrompt() {
  let projInfo = 'No projects yet.';
  try {
    const snap = await getDocs(query(collection(db,'projects'),orderBy('ts','desc')));
    const projs = [];
    snap.forEach(d=>projs.push(d.data()));
    if(projs.length) {
      projInfo = projs.slice(0, 10).map((p, i) => `${i===0 ? '[LATEST NEWEST PROJECT] ' : ''}${i+1}. ${p.name}: ${p.desc} (created by ${p.creatorName})`).join('\n');
    }
  } catch(e) {}
  
  return `System: I'm HAZA AI Specially Desinged For Collabaration Team.
Our platform is "HAZA Collaborators ‚Äî Where Teams Build the Future", a website for team collaboration, chat, projects, and updates.

=== REAL-TIME LIVE DATA ===
Here is the current, up-to-date list of newest projects in our database in chronological order (from newest to oldest). THE VERY FIRST ITEM (#1) IS CURRENTLY THE LATEST PROJECT. ALWAYS base your answers about the latest project strictly on THIS list, completely ignoring any past cached answers in this conversation if they differ:
${projInfo}
===========================

CRITICAL INSTRUCTION: You DO NOT have the ability to create projects, modify the database, or add users. If the user asks you to create a project or perform any action that changes data, politely refuse and say "I can't do that" or "mata eka karanna baha". Only answer questions and provide information.
Answer strictly based on this context. Answer questions concisely and politely.`;
}

window.sendBotMsg = async function(){
  const inp = document.getElementById('bot-input');
  const text = inp.value.trim();
  if(!text) return;
  inp.value = '';

  const emptyEl = document.getElementById('bot-empty');
  if(emptyEl) emptyEl.style.display = 'none';

  addBotMsgBubble(text, 'own', CU.name||CU.email, CU.color||'#ffb43c');

  const c = document.getElementById('bot-msgs');
  const loadId = 'bot-load-'+Date.now();
  c.innerHTML += `<div class="msg-wrap" id="${loadId}" style="margin:5px 0;">
    <div class="msg-row">
      <div class="msg-avatar" style="background:linear-gradient(135deg,#00e5ff,#34d399);">ü§ñ</div>
      <div class="msg-bubble other" style="padding:12px;"><div class="loader" style="width:12px;height:12px;border:2px solid rgba(0,229,255,0.3);border-top-color:#00e5ff;"></div></div>
    </div>
  </div>`;
  c.scrollTop = c.scrollHeight;

  botHistory.push({role:'user', content:text});

  try {
    const sysPrompt = await getSystemPrompt();
    const messages = [{role:'system', content:sysPrompt}, ...botHistory];

    const res = await fetch('https://text.pollinations.ai/openai', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Authorization': 'Bearer sk_WYQq3e0YYXWHD2HvrGuDpybUJ5ZfPHxc'
      },
      body: JSON.stringify({ messages: messages, model: 'openai', temperature: 0.7 })
    });
    
    if (!res.ok) {
      const err = await res.json().catch(()=>({}));
      throw new Error(err?.error?.message || 'Request failed Refresh and Try again');
    }
    
    const data = await res.json();
    const ans = data.choices[0].message.content;
    botHistory.push({role:'assistant', content:ans});
    const loaderEl = document.getElementById(loadId);
    if(loaderEl) loaderEl.remove();
    addBotMsgBubble(ans, 'other', 'HAZA AI', '#00e5ff');
  } catch(e) {
    console.error(e);
    const loaderEl = document.getElementById(loadId);
    if(loaderEl) loaderEl.remove();
    addBotMsgBubble('Error: ' + e.message, 'other', 'HAZA AI', '#f87171');
  }
};

function addBotMsgBubble(text, type, name, color) {
  const c = document.getElementById('bot-msgs');
  const own = type==='own';
  const initial = own ? String(name||'?').substr(0,1).toUpperCase() : 'ü§ñ';
  
  // Use marked.js for bot responses to parse markdown
  const renderedText = own ? esc(text).replace(/\n/g,'<br>') : marked.parse(text);
  
  const html = `<div class="msg-wrap" style="margin:5px 0;">
    <div class="msg-meta${own?' own':''}"><span style="font-size:0.67rem;color:var(--muted);font-family:'JetBrains Mono',monospace;">${esc(name)}</span></div>
    <div class="msg-row${own?' own':''}" style="display:flex;align-items:flex-end;gap:7px;${own?'flex-direction:row-reverse;':''}">
      ${!own?`<div class="msg-avatar" style="width:26px;height:26px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-family:'Clash Display',sans-serif;font-weight:700;font-size:0.65rem;color:#000;flex-shrink:0;background:linear-gradient(135deg,${color},#00b4d8);">${initial}</div>`:``}
      <div class="msg-bubble ${own?'own':'other'} markdown-body" style="max-width:62%;padding:9px 13px;border-radius:13px;word-break:break-word;${own?'background:rgba(255,180,60,0.1);border:1px solid var(--border-bright);border-bottom-right-radius:3px;':'background:var(--surface2);border:1px solid var(--border);border-bottom-left-radius:3px;'}">${renderedText}</div>
    </div>
  </div>`;
  c.innerHTML += html;
  c.scrollTop = c.scrollHeight;
}

// ‚îÄ‚îÄ‚îÄ LOCAL NOTES ‚îÄ‚îÄ‚îÄ
window.saveNote = function() {
  const inp = document.getElementById('note-input');
  const text = inp.value.trim();
  if(!text) return;
  
  let notes = [];
  try { notes = JSON.parse(localStorage.getItem('haza_notes_'+CU.uid)) || []; } catch(e){}
  
  notes.unshift({ id: Date.now().toString(), text, ts: Date.now() });
  localStorage.setItem('haza_notes_'+CU.uid, JSON.stringify(notes));
  
  inp.value = '';
  toast('Personal note saved locally!', 'success');
  renderNotes();
};

window.delNote = function(id) {
  let notes = [];
  try { notes = JSON.parse(localStorage.getItem('haza_notes_'+CU.uid)) || []; } catch(e){}
  notes = notes.filter(n => n.id !== id);
  localStorage.setItem('haza_notes_'+CU.uid, JSON.stringify(notes));
  toast('Note removed', 'info');
  renderNotes();
};

window.renderNotes = function() {
  const c = document.getElementById('notes-list');
  let notes = [];
  try { notes = JSON.parse(localStorage.getItem('haza_notes_'+CU.uid)) || []; } catch(e){}
  
  if(!notes.length) {
    c.innerHTML = '<div class="empty"><div class="ei">üìù</div><p>No personal notes yet. Everything here stays only on this device.</p></div>';
    return;
  }
  
  c.innerHTML = notes.map(n => `
    <div class="note-item">
      <button class="note-del" onclick="delNote('${n.id}')">‚úï Delete</button>
      <div class="note-text markdown-body">${marked.parse(n.text)}</div>
      <div class="note-meta">${new Date(n.ts).toLocaleString()}</div>
    </div>
  `).join('');
};

// ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ
window.doLogout = async function(){ await signOut(auth);window.location.href='login.html'; };
window.goAdmin  = function(){ window.location.href='admin.html'; };
</script>

<!-- Three.js BG -->
<script>
(function(){
  const c=document.getElementById('bg-canvas');if(!window.THREE)return;
  const r=new THREE.WebGLRenderer({canvas:c,antialias:true,alpha:true});
  r.setPixelRatio(Math.min(devicePixelRatio,2));r.setSize(innerWidth,innerHeight);
  const scene=new THREE.Scene();
  const cam=new THREE.PerspectiveCamera(65,innerWidth/innerHeight,0.1,1000);
  cam.position.z=60;
  const rings=[];
  const rGeo=[new THREE.TorusGeometry(12,0.05,8,80),new THREE.TorusGeometry(20,0.035,8,80),new THREE.TorusGeometry(30,0.025,8,80)];
  const rMat=[
    new THREE.MeshBasicMaterial({color:0xffb43c,transparent:true,opacity:0.12}),
    new THREE.MeshBasicMaterial({color:0xff7c2a,transparent:true,opacity:0.08}),
    new THREE.MeshBasicMaterial({color:0x00e5ff,transparent:true,opacity:0.05}),
  ];
  rGeo.forEach((g,i)=>{const m=new THREE.Mesh(g,rMat[i]);m.rotation.x=Math.PI/4+i*0.3;scene.add(m);rings.push(m);});
  const N=400;const pos=new Float32Array(N*3);const col=new Float32Array(N*3);
  for(let i=0;i<N;i++){
    pos[i*3]=(Math.random()-0.5)*180;pos[i*3+1]=(Math.random()-0.5)*180;pos[i*3+2]=(Math.random()-0.5)*60;
    const t=Math.random();
    if(t<0.6){col[i*3]=1;col[i*3+1]=0.7;col[i*3+2]=0.23;}
    else if(t<0.85){col[i*3]=1;col[i*3+1]=0.49;col[i*3+2]=0.16;}
    else{col[i*3]=0;col[i*3+1]=0.9;col[i*3+2]=1;}
  }
  const pGeo=new THREE.BufferGeometry();
  pGeo.setAttribute('position',new THREE.BufferAttribute(pos,3));
  pGeo.setAttribute('color',new THREE.BufferAttribute(col,3));
  scene.add(new THREE.Points(pGeo,new THREE.PointsMaterial({size:0.4,vertexColors:true,transparent:true,opacity:0.4})));
  let mx=0,my=0;
  document.addEventListener('mousemove',e=>{mx=(e.clientX/innerWidth-0.5)*0.4;my=-(e.clientY/innerHeight-0.5)*0.4;});
  (function anim(){
    requestAnimationFrame(anim);
    const t=Date.now()*0.0003;
    rings.forEach((ring,i)=>{ring.rotation.z=t*(0.15+i*0.07);ring.rotation.y=t*0.05+mx*0.3;ring.rotation.x=Math.PI/4+i*0.3+my*0.2;});
    cam.position.x+=(mx*5-cam.position.x)*0.04;
    cam.position.y+=(my*5-cam.position.y)*0.04;
    cam.lookAt(0,0,0);r.render(scene,cam);
  })();
  window.addEventListener('resize',()=>{cam.aspect=innerWidth/innerHeight;cam.updateProjectionMatrix();r.setSize(innerWidth,innerHeight);});
})();
</script>
</body>
</html>